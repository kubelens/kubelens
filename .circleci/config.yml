kubelens_root: &kubelens_root
  working_directory: /go/src/github.com/kubelens/kubelens

version: 2
jobs:
  api_build:
    docker: 
      - image: circleci/golang:latest
    environment:
      VERSION: "1.0"
      GOBIN: /go/bin
    <<: *kubelens_root
    steps:
      - checkout
      - setup_remote_docker
      - run: 
          name: Check API Changes
          command: |
            git diff --name-only --exit-code HEAD~1..HEAD  ./api && \
            echo 'export API_CHANGED=false' >> $BASH_ENV || \
            echo 'export API_CHANGED=true' >> $BASH_ENV
            source $BASH_ENV
      - run:
          name: Run Test & Coverage
          command: |
            if ${API_CHANGED}; then
              cd ./api 
              make test
            fi
      - run:
          name: Build & Push Docker image
          command: |
            if ${API_CHANGED}; then
              cd ./api
              GIT_BRANCH=${CIRCLE_BRANCH} \
              TAG="${VERSION}.${CIRCLE_BUILD_NUM}" \
              DOCKER_ID=${DOCKER_ID} \
              DOCKER_USER=${DOCKER_USER} \
              DOCKER_PASS=${DOCKER_PASS} \
              make -s docker-build-push
            fi
    
workflows:
  version: 2
  test_build_deploy:
    jobs:
      - api_build:
          filters:
            branches:
              only: 
                - staging
                - master
